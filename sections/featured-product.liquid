{%- assign product = all_products[section.settings.featured_product] -%}
<script>
  SECOMAPP.pl.product = {
        id: {{ product.id }},
        published_at: "{{ product.published_at }}",
        price: {{ product.price }}, {% if product.compare_at_price%}
        compare_at_price: {{ product.compare_at_price }}, {% endif %} {% if product.tags %}
        tags: {{ product.tags | json }}, {% endif %}
        variants: [ {% for variant in product.variants %} {
            id: {{ variant.id }},
            price: {{ variant.price }} {% if variant.compare_at_price%},
            compare_at_price: {{ variant.compare_at_price }} {% endif %} {% if variant.inventory_quantity%},
            inventory_quantity: {{ variant.inventory_quantity }} {% endif %} {% if variant.inventory_management and variant.inventory_management != blank%},
            inventory_management: '{{ variant.inventory_management }}' {% endif %} {% if variant.weight%},
            weight: {{ variant.weight }} {% endif %} {% if variant.sku and variant.sku != blank%},
            sku: '{{ variant.sku | replace: '"', '' }}' {% endif %} } {% unless forloop.last %},{% endunless %}
            {% endfor %}
        ],
        collections: [ {% for collection in product.collections %} {{ collection.id }}, {% endfor %} ]
    };
</script>
{%- render 'product-template',
  product: product,
  section_id: product.id,
  blocks: section.blocks,
  handle: product.handle,

  image_container_width: section.settings.product_image_size,
  product_image_type: section.settings.product_image_type,
  product_zoom_enable: section.settings.product_zoom_enable,
  sku_enable: section.settings.sku_enable,
  video_looping: section.settings.enable_video_looping,
  video_style: section.settings.product_video_style
-%}



{% schema %}
  {
    "name": "Featured product",
    "settings": [
      {
        "type": "product",
        "id": "featured_product",
        "label": "Product"
      },
      {
        "type": "header",
        "content": "Media"
      },
      {
        "type": "select",
        "id": "product_image_size",
        "label": "Image size",
        "default": "medium",
        "options": [
          {
            "value": "small",
            "label": "Small"
          },
          {
            "value": "medium",
            "label": "Medium"
          },
          {
            "value": "large",
            "label": "Large"
          }
        ]
      },
      {
        "type": "select",
        "id": "product_image_type",
        "label": "Image style",
        "default": "stacked",
        "options": [
          {
            "value": "stacked",
            "label": "Stacked"
          },
          {
            "value": "slider",
            "label": "Fade"
          }
        ]
      },
      {
        "type": "checkbox",
        "id": "product_zoom_enable",
        "label": "Enable image zoom"
      },
      {
        "type": "checkbox",
        "id": "enable_video_looping",
        "label": "Enable video looping",
        "default": true
      },
      {
        "type": "select",
        "id": "product_video_style",
        "label": "Video style",
        "default": "muted",
        "options": [
          {
            "value": "muted",
            "label": "Video without sound"
          },
          {
            "value": "unmuted",
            "label": "Video with sound"
          }
        ],
        "info": "Video with sound will not autoplay"
      },
      {
        "type": "header",
        "content": "Product settings"
      },
      {
        "type": "checkbox",
        "id": "sku_enable",
        "label": "Show SKU"
      }
    ],
    "blocks": [
      {
        "type": "@app"
      },
      {
        "type": "price",
        "name": "Price",
        "limit": 1
      },
      {
        "type": "quantity_selector",
        "name": "Quantity selector",
        "limit": 1
      },
      {
        "type": "variant_picker",
        "name": "Variant picker",
        "limit": 1,
        "settings": [
          {
            "type": "checkbox",
            "id": "variant_labels",
            "label": "Show variant labels",
            "default": true
          },
          {
            "type": "select",
            "id": "picker_type",
            "label": "Type",
            "options": [
              {
                "value": "button",
                "label": "Buttons"
              },
              {
                "value": "dropdown",
                "label": "Dropdown"
              }
            ],
            "default": "button"
          },
          {
            "type": "checkbox",
            "id": "color_swatches",
            "label": "Enable color swatches",
            "info": "Requires type to be set to 'Buttons'. [Learn how to set up swatches](https://archetypethemes.co/blogs/impulse/how-do-i-set-up-color-swatches)"
          }
        ]
      },
      {
        "type": "description",
        "name": "Description",
        "limit": 1,
        "settings": [
          {
            "type": "checkbox",
            "id": "is_tab",
            "label": "Show as tab"
          }
        ]
      },
      {
        "type": "buy_buttons",
        "name": "Buy buttons",
        "limit": 1,
        "settings": [
          {
            "type": "checkbox",
            "id": "show_dynamic_checkout",
            "label": "Show dynamic checkout button",
            "info": "Lets customers check out directly using a familiar payment method. [Learn more](https://help.shopify.com/manual/using-themes/change-the-layout/dynamic-checkout)",
            "default": true
          },
          {
            "type": "checkbox",
            "id": "surface_pickup_enable",
            "label": "Enable pickup availability feature",
            "info": "Learn how to setup this feature [here](https://help.shopify.com/en/manual/shipping/setting-up-and-managing-your-shipping/local-methods/local-pickup)",
            "default": true
          }
        ]
      },
      {
        "type": "inventory_status",
        "name": "Inventory status",
        "limit": 1,
        "settings": [
          {
            "type": "range",
            "id": "inventory_threshold",
            "label": "Low inventory threshold",
            "default": 10,
            "min": 0,
            "max": 20,
            "step": 2
          },
          {
            "type": "checkbox",
            "id": "inventory_transfers_enable",
            "label": "Show inventory transfer notice",
            "info": "Learn how to create inventory transfers [here](https://help.shopify.com/en/manual/products/inventory/transfers/create-transfer)",
            "default": true
          }
        ]
      },
      {
        "type": "sales_point",
        "name": "Sales point",
        "settings": [
          {
            "type": "select",
            "id": "icon",
            "label": "Icon",
            "default": "globe",
            "options": [
              {
                "value": "checkmark",
                "label": "Checkmark"
              },
              {
                "value": "globe",
                "label": "Globe"
              },
              {
                "value": "leaf",
                "label": "Leaf"
              },
              {
                "value": "package",
                "label": "Package"
              },
              {
                "value": "lock",
                "label": "Lock"
              },
              {
                "value": "truck",
                "label": "Truck"
              }
            ]
          },
          {
            "type": "text",
            "id": "text",
            "label": "Text",
            "default": "Free worldwide shipping"
          }
        ]
      },
      {
        "type": "text",
        "name": "Text",
        "settings": [
          {
            "type": "text",
            "id": "text",
            "default": "Text block",
            "label": "Text"
          }
        ]
      },
      {
        "type": "trust_badge",
        "name": "Trust badge",
        "settings": [
          {
            "type": "image_picker",
            "id": "trust_image",
            "label": "Image"
          }
        ]
      },
      {
        "type": "tab",
        "name": "Tab",
        "settings": [
          {
            "type": "text",
            "id": "title",
            "label": "Heading",
            "default": "Shipping information"
          },
          {
            "type": "richtext",
            "id": "content",
            "label": "Tab content",
            "default": "<p>Use collapsible tabs for more detailed information that will help customers make a purchasing decision.</p><p>Ex: Shipping and return policies, size guides, and other common questions.</p>"
          },
          {
            "type": "page",
            "id": "page",
            "label": "Tab content from page"
          }
        ]
      },
      {
        "type": "share",
        "name": "Share on social",
        "limit": 1,
        "settings": [
          {
            "type": "paragraph",
            "content": "Choose which platforms to share to in global theme settings"
          }
        ]
      },
      {
        "type": "separator",
        "name": "Separator"
      },
      {
        "type": "contact",
        "name": "Contact form",
        "limit": 1,
        "settings": [
          {
            "type": "paragraph",
            "content": "All submissions are sent to the customer email address of your store. [Learn more](https://help.shopify.com/en/manual/using-themes/change-the-layout/add-contact-form#view-contact-form-submissions)."
          },
          {
            "type": "text",
            "id": "title",
            "label": "Heading",
            "default": "Ask a question"
          },
          {
            "type": "checkbox",
            "id": "phone",
            "label": "Add phone number field"
          }
        ]
      },
      {
        "type": "reviews",
        "name": "Product reviews badge",
        "limit": 1,
        "settings": [
          {
            "type": "paragraph",
            "content": "Add reviews by installing the [Shopify Product Reviews app](https://apps.shopify.com/product-reviews) and following our [setup guide](https://archetypethemes.co/blogs/support/installing-shopifys-product-reviews-app)"
          }
        ]
      },
      {
        "type": "custom",
        "name": "HTML",
        "settings": [
          {
            "type": "liquid",
            "id": "code",
            "label": "HTML",
            "default": "<h4>Custom code block</h4><p>Use this advanced section to add custom HTML, app scripts, or liquid.</p>",
            "info": "Supports Liquid"
          }
        ]
      }

    ],
    "presets": [
      {
        "name": "Featured product",
        "blocks": [
          { "type": "price" },
          { "type": "description" },
          { "type": "variant_picker" },
          { "type": "buy_buttons" }
        ]
      }
    ]
  }
{% endschema %}
<script type="text/javascript">
   
    document.body.addEventListener('click', ({target})=>{
      if(target.closest('.custom-sold-out-parent')){
        let parentEl = target.closest('.product-block');
    
        if(parentEl.nextElementSibling.querySelector('#sold-out-btn')){
           parentEl.nextElementSibling.querySelector('#sold-out-btn').style.display= 'block';
        }
        if(parentEl.nextElementSibling.querySelector('.payment-buttons')){
           parentEl.nextElementSibling.querySelector('.payment-buttons').style.display= 'none';
        }
       
       
      }

      if(target.closest('.variant-input:not(.custom-sold-out-parent)')){
        let parentEl = target.closest('.product-block');
   
        if(parentEl.nextElementSibling.querySelector('#sold-out-btn')){
           parentEl.nextElementSibling.querySelector('#sold-out-btn').style.display= 'none';
         }
       if(parentEl.nextElementSibling.querySelector('.payment-buttons')){
             parentEl.nextElementSibling.querySelector('.payment-buttons').removeAttribute('style');
         }
        if(   parentEl.nextElementSibling.querySelector('.payment-buttons button')){
          parentEl.nextElementSibling.querySelector('.payment-buttons button').classList.remove('iia-disabled-button');
          }
    
        
        
      }
    });
    var product_id = {{product.id | json}};
   
 
      var countryHomePage;
      if (Shopify.country == 'GB' || Shopify.country == 'IM' || Shopify.country == 'JE' || Shopify.country == 'GG') {
        countryHomePage = 'GB';
      } else {
        countryHomePage = 'NL';
      }
  
  (function(){
    let handleName = {{ product.handle | json}};
    let id = {{ product.id | json }};

    (function () {
      const loadApp = function () {
        let productIdentifier = {
          handle: handleName
        };

        window.inventoryInfo.api.loadApp(productIdentifier, `div#ProductSection-${id}`);
       
        
      };
      if (window.inventoryInfo) {
        loadApp();
      } else {
        document.addEventListener('inventoryInfo.appLoaded', function () {
          loadApp();
        });
      }
    })();

    function hideVariants() {
      function waitForElem(waitFor, callback, minElements = 1, isVariable = false, timer = 10000, frequency = 25) {
        let elements = isVariable ? window[waitFor] : document.querySelectorAll(waitFor);
        if (timer <= 0) return;

        (!isVariable && elements.length >= minElements) || (isVariable && typeof window[waitFor] !== 'undefined')
          ? callback(elements)
          : setTimeout(() => waitForElem(waitFor, callback, minElements, isVariable, timer - frequency), frequency);
      }
      function waitForNestedVariable(waitFor, callback, timer = 10000, frequency = 25) {
        let variable = ''
        waitFor.forEach((value,index)=>{
          if(index == 0){
            variable=window[value]
          }  
          else{
            variable = variable[value]
          }      
        });
        if (timer <= 0) return;

        (typeof variable !== 'undefined')
          ? callback(variable)
          : setTimeout(() => waitForNestedVariable(waitFor, callback, timer - frequency), frequency);
      }
      
      waitForElem(
        'inventoryInfo',
        (el) => {
          handleOutOfStock();
        },
        1,
        true
      );


      function handleOutOfStock(){
        waitForNestedVariable(['inventoryInfo',handleName,'data'],(value)=>{
       
          window.inventoryInfo[handleName].data.variantLocations.forEach((location,index)=>{
            
            let inventories = location.inventoryLocations;   
            let skippedItem = true;
            let available = false;
            inventories.forEach((inventory)=>{
              if(inventory.quantity != 0 || inventory.quantity == null){
                skippedItem = false; 
              
                if((inventory.location.country == countryHomePage && inventory.quantity != 0 ) || (inventory.quantity == null && inventory.location.country == countryHomePage)){
                  available = true;
                }
              }  
            });
            
            if(skippedItem){
            
              return;
            }

          
            
            if(!available){     
              document.querySelector(`[data-variant-id="${location.variant}"] > label`).classList.add('disabled');
              document.querySelector(`[data-variant-id="${location.variant}"]`).classList.add('custom-sold-out-parent');
            }else{
              
            }
          });
        });  

       
        

      };
   
      let soldOutBtn = '';
        
      waitForElem(`#ProductSection-${product_id} .payment-buttons`, (element) => {
     
        if (element[0].innerText == 'ADD TO CART') {
          let clonedNode =
          '<span id="sold-out-btn" class="btn btn--full add-to-cart btn--tertiary disabled" disabled style="display:none;">SOLD OUT</span>';
           //document.querySelector('.payment-buttons').insertAdjacentHTML('beforebegin', clonedNode);
          element[0].closest(`#ProductSection-${product_id} .payment-buttons`).insertAdjacentHTML('beforebegin', clonedNode);
        
        }else{
            let clonedNode =
        '<span id="sold-out-btn" class="btn btn--full add-to-cart btn--tertiary disabled" disabled style="display:none;">SOLD OUT</span>';
        //document.querySelector('.payment-buttons').insertAdjacentHTML('beforebegin', clonedNode);
          element[0].closest(`#ProductSection-${product_id} .payment-buttons`).insertAdjacentHTML('beforebegin', clonedNode);
        }
      });
     
   

      // click event handler for variants which are sold out this will handle the 'add to basket' button hide operation
      waitForElem('.variant-input-wrap > .variant-input.custom-sold-out-parent',(node)=>{
        for(let i=0; i < node.length; i++){
          
          node[i].addEventListener('click',(e)=>{
           
           let targetPare = e.target.closest('.variant-input');
           let targetElem = e.target.closest('.product-block');
            if (targetPare) {
              if (targetPare.querySelector('label').classList.contains('disabled')) {
                let soldOutBtn = targetElem.nextElementSibling.querySelector('#sold-out-btn');
            
                if (soldOutBtn) {
                  soldOutBtn.style.display = 'block';
                }
              
                
                let b = targetElem.nextElementSibling.querySelector('.payment-buttons button[type=submit]');
                b.style.display = 'none';
                targetElem.nextElementSibling.querySelector('div.shopify-payment-button').style.display = 'none';
                let stockInfo = targetElem.nextElementSibling.querySelector('div.product-block.product-block--sales-point');
                if (stockInfo) {
                  //stockInfo.classList.add('hide');
                  stockInfo.style.display = 'none';
                }
                setTimeout(() => {
                  let notifyPanel = targetElem.nextElementSibling.querySelector('div.si-reset.si-edge-right.si-edge-top.si-rotate-270');
                  if (notifyPanel) {
                    notifyPanel.children[0].style.display = 'none';
                    
                  }
                }, 20);
              }
            }



          });
        }
      });
     
      // click event handler for variants which are available and will handle the 'sold out' button hide operation
      document.querySelectorAll('.variant-input-wrap > .variant-input:not(.custom-sold-out-parent)').forEach((item) => {
        item.addEventListener('click', (e) => {
          let targetPare = e.target.closest('.variant-input');
          let targetElem = e.target.closest('.product-block');
          if (targetPare) {
            let soldOutBtn = targetElem.nextElementSibling.querySelector('#sold-out-btn');
            if (soldOutBtn) {
              soldOutBtn.style.display = 'none';
            }
            let b = targetElem.nextElementSibling.querySelector('.payment-buttons button[type=submit]');
            let inventoryInfo = targetElem.nextElementSibling.querySelector('#inventory-info-app');
            if (inventoryInfo) {
              
              inventoryInfo.style.display = 'none';
            }
            b.style.display = 'block';
            if(soldOutBtn){
              soldOutBtn.style.display = 'none';
            }
            
            targetElem.nextElementSibling.querySelector('div.shopify-payment-button').style.display = 'block';
            let inStockInfo = targetElem.nextElementSibling.querySelector('div.product-block.product-block--sales-point');
            if (inStockInfo) {
              //inStockInfo.classList.remove('hide');
              inStockInfo.style.display = 'block';
            }
            let notifyPanel = targetElem.nextElementSibling.querySelector('div.si-reset.si-edge-right.si-edge-top.si-rotate-270');
            if (notifyPanel) {
              notifyPanel.children[0].style.display = 'none';
              
            }
          }
        });
      });

      
       (function pollFor(){
         if(document.readyState == 'complete' ){
           document.querySelectorAll('input:checked').forEach((item, index)=>{
          
              if(item.closest('.variant-input.custom-sold-out-parent')){
                  let parentEl = item.closest('.product-block');
                  if(parentEl.nextElementSibling.querySelector('#sold-out-btn')){
                    parentEl.nextElementSibling.querySelector('#sold-out-btn').style.display = 'block';
                  }else{
                      let clonedNode =
        '<span id="sold-out-btn" class="btn btn--full add-to-cart btn--tertiary disabled" disabled style="display:block;">SOLD OUT</span>';
                    parentEl.nextElementSibling.querySelector('.payment-buttons').insertAdjacentHTML('beforebegin', clonedNode);
                  }
                 parentEl.nextElementSibling.querySelector('.payment-buttons button.btn').style.display="none";
                 parentEl.nextElementSibling.querySelector('.payment-buttons button.btn + div').style.display="none";
                  
              }else{
                 let parentEl = item.closest('.product-block');
                 if ( parentEl.nextElementSibling.querySelector('#sold-out-btn')){
                   parentEl.nextElementSibling.querySelector('#sold-out-btn').style.display = 'none';   
                 }
                parentEl.nextElementSibling.querySelector('.payment-buttons button.btn').style.display="block";
                 parentEl.nextElementSibling.querySelector('.payment-buttons button.btn + div').style.display="block";
                 
              }
          });
         }else{
            setTimeout(pollFor, 25);
         }
       })();
     
  

    };

  
  
    hideVariants();

  })();
</script>

